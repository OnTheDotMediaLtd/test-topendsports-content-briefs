name: CI Tests

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  test-mcp-server:
    name: Test MCP Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'mcp-server/package-lock.json'

      - name: Install dependencies
        run: |
          cd mcp-server
          npm ci

      - name: Build MCP server
        run: |
          cd mcp-server
          npm run build

      - name: Run MCP server tests
        run: |
          cd mcp-server
          npm test
        continue-on-error: false

      - name: Check TypeScript compilation
        run: |
          cd mcp-server
          npx tsc --noEmit

  test-python:
    name: Test Python Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock python-docx requests urllib3

      - name: Run pytest
        run: |
          pytest tests/python/ -v --tb=short
        continue-on-error: false

      - name: Check Python syntax
        run: |
          python -m py_compile .claude/scripts/*.py
          python -m py_compile content-briefs-skill/scripts/*.py

  test-shell:
    name: Test Shell Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Make scripts executable
        run: |
          chmod +x .claude/scripts/*.sh
          chmod +x content-briefs-skill/scripts/*.sh

      - name: Run shell script tests
        run: |
          if [ -d "tests/shell" ] && [ -n "$(ls -A tests/shell/*.bats 2>/dev/null)" ]; then
            bats tests/shell/*.bats
          else
            echo "No shell tests found, creating basic validation tests..."
            mkdir -p tests/shell

            # Create a basic test to verify scripts exist and are executable
            cat > tests/shell/basic.bats <<'EOFBATS'
            #!/usr/bin/env bats

            @test "ahrefs-api.py exists and is executable" {
              [ -x ".claude/scripts/ahrefs-api.py" ]
            }

            @test "validate-phase.sh exists and is executable" {
              [ -x "content-briefs-skill/scripts/validate-phase.sh" ]
            }

            @test "mcp-ahrefs.sh exists and is executable" {
              [ -x ".claude/scripts/mcp-ahrefs.sh" ]
            }

            @test "Shell scripts have proper shebang" {
              grep -q "#!/bin/bash" .claude/scripts/mcp-ahrefs.sh
            }
            EOFBATS

            bats tests/shell/basic.bats
          fi
        continue-on-error: false

  all-tests-passed:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [test-mcp-server, test-python, test-shell]

    steps:
      - name: Confirm all tests passed
        run: |
          echo "âœ… All test suites passed successfully!"
          echo "- MCP Server tests: PASSED"
          echo "- Python tests: PASSED"
          echo "- Shell tests: PASSED"
